<!DOCTYPE html>

<div id=TaskManagerContainer></div>

<template id=Modulin>

  <template id=TaskManager>
    <TaskManager.List>
      <div class="test"></div>
    </TaskManager.List>
    <modulin.CloseButton data-test="abc" data-abc="test"></modulin.CloseButton>
    <TaskManager.Header></TaskManager.Header>
    <TaskManager.VisibilityFilter>
      <VisibilityFilter.Connector>
        <Connector.Connector2></Connector.Connector2>
        <VisibilityFilter.Connector2></VisibilityFilter.Connector2>
      </VisibilityFilter.Connector>
    </TaskManager.VisibilityFilter>

    <template id=Header>
      <div class="header">A header</div>
    </template>

    <template id=VisibilityFilter>
      <div class="all"></div>
      <VisibilityFilter.FilterButton data-filter=all></VisibilityFilter.FilterButton>
      <VisibilityFilter.FilterButton data-filter=open></VisibilityFilter.FilterButton>
      <VisibilityFilter.FilterButton data-filter=close></VisibilityFilter.FilterButton>
      <div data-content></div>
    </template>
  </template>

  <template id=TaskManager.VisibilityFilter.FilterButton>
    <div class="action"></div>
  </template>

  <template id=TaskManager.List>
    <div class="a_list"></div>
    <div data-content></div>
  </template>

  <template id=CloseButton>
    <div class="action"></div>
    <Modulin.TaskManager.List>
      <div>abc</div>
    </Modulin.TaskManager.List>
  </template>

</template>

<script>
  var arrayMethods = Object.getOwnPropertyNames(Array.prototype);

  [NodeList, HTMLCollection, NamedNodeMap].forEach(addArrayMethods);

  function addArrayMethods(object) {
    arrayMethods.forEach(attachArrayMethodsToNodeList.bind(object));

  }

  function attachArrayMethodsToNodeList(methodName) {
    if (methodName !== "length" && !this.prototype[methodName]) {
      Object.defineProperty(this.prototype, methodName, {
        enumerable: false,
        configurable: false,
        writable: false,
        value: Array.prototype[methodName]
      });
    }
  }
</script>

<script>


  class Module {
    inject(element, context) {
      this.context = context;
      this.element = element;
    }

    mounted(){ }
  }

  class TemplateRegistry {

    constructor() {
      this.registry = {};
    }

    registerTemplate(id, namespace = []) {
      var node = document.getElementById(id);
      var registry = {};

      this.traverseTemplate(node, namespace, registry);
      var resolvedTemplates = Object.keys(registry)
        .map((key)=>this.resolveTemplate(registry[key], key))
        .reduce((obj, template)=>{
          obj[template.qualifierName] = template;
          return obj; }, {});

      this.registry = resolvedTemplates;
    }

    traverseTemplate(node, namespace, registry) {
      var childTemplates = this.findTagsInTemplate(node);
      var name = node.id.split('.');

      namespace = namespace.concat(name);
      childTemplates.map((template)=>this.traverseTemplate(template, namespace, registry));

      var qualifierName = namespace.join('.').toLowerCase();
      console.assert(registry[qualifierName] === undefined, `The template ${qualifierName} is already registered`);

      var expandedTemplate = this.expandTemplate(node);
      expandedTemplate.children
        .filter((child)=>child.nodeName === 'TEMPLATE')
        .map((child)=>expandedTemplate.removeChild(child));

      registry[qualifierName] = expandedTemplate
    }

    expandTemplate(template) {
      var expandedTemplate = document.createElement('div');
      expandedTemplate.innerHTML = template.innerHTML;
      return expandedTemplate;
    }

    findTagsInTemplate(template, tag = 'template') {
      return this
        .expandTemplate(template)
        .getElementsByTagName(tag);
    }

    resolveTemplate(template, templateQualifierName) {
      var children = template.children
        .map((child)=>this.resolveFullQualifierName(templateQualifierName, child));

      return {qualifierName: templateQualifierName, node: template, children};
    }

    resolveFullQualifierName(templateQualifierName, node) {
      var unNormalizedQualifierName = `.${templateQualifierName}.${node.nodeName}`
        .toLowerCase();
      var qualifierName = unNormalizedQualifierName
        .replace(/\.(.+)\..*\1/, (_, $1)=>`.${$1}`)
        .substr(1);
      var children = node.children
        .map((child)=>this.resolveFullQualifierName(templateQualifierName, child));
      var attributes = node.attributes
        .filter((attr)=>attr.name.indexOf('data-') === 0)
        .map((attr)=>[attr.name.replace('data-',''), attr.value])
        .reduce((obj, keyValue) => {
          obj[keyValue[0]] = keyValue[1];
          return obj;
        }, {});

      return {qualifierName, node, children, attributes};
    }
  }
  var templateRegistry = new TemplateRegistry();

  class ModuleRegistry {

    constructor() {
      this.defaultNamespace = ['modulin'];
      this.registry = {};
    }

    register(parentOrModule, module) {
      var parent = null;
      var namespace = [];
      if (!module) {
        module = parentOrModule;
      } else {
        parent = parentOrModule;
      }

      if (parent) {
        namespace = parent.__namespace.concat(parent.name);
      } else {
        namespace = this.defaultNamespace;
      }

      var qualifierName = namespace.concat(module.name).join('.').toLowerCase();
      module.__namespace = namespace;
      this.registry[qualifierName] = module;
    }
  }
  var moduleRegistry = new ModuleRegistry();

</script>

<script>
  class ViewModel {
    constructor(properties){
      var get = this.get.bind(this);
      var set = this.set.bind(this);
      this.set = (property, value)=> set(properties, property, value);
      this.get = (property)=> get(properties, property);
      this.listeners = [];
    }

    set(properties, property, value){
      properties[property] = value;

      var diff = {};
      diff[property] = value;
      this.triggerChange(diff);
    }

    get(properties, property){
      return properties[property];
    }

    onChange(callback){
      this.listeners.push(callback);
    }

    triggerChange(diff){
      this.listeners.forEach((listener)=>listener(diff));
    }
  }

  class TaskManager extends Module {
    constructor(){
      super();
      this.taskView = new ViewModel({
        name: 'A name'
      });
    }
  }

  class Header extends Module {

    mounted(){
      this.updateTitle(this.context.taskView.get('name'));

      this.context.taskView.onChange((diff)=>{
        var name = diff['name'];
        if(name !== undefined){
          this.updateTitle(name);
        }
      })
    }

    updateTitle(title){
      this.element.querySelector('.header').innerHTML = title;
    }
  }

  class VisibilityFilter extends Module {
    mounted(){
      setInterval(()=>{
        this.context.taskView.set('name', Math.random());
      }, 20);
    }
  }

  class Connector extends Module {
  }

  class List extends Module {

  }

  class CloseButton extends Module {
  }

  moduleRegistry.register(TaskManager);
  moduleRegistry.register(CloseButton);
  moduleRegistry.register(TaskManager, Header);
  moduleRegistry.register(TaskManager, List);
  moduleRegistry.register(TaskManager, VisibilityFilter);

  moduleRegistry.register(VisibilityFilter, Connector);
</script>

<script>

  templateRegistry.registerTemplate('Modulin');

  createModule(document.getElementById('TaskManagerContainer'), TaskManager);

  function createModule(attachmentPoint, moduleClass) {
    var qualifierName = moduleClass.__namespace.concat(moduleClass.name).join('.').toLowerCase();
    var template = templateRegistry.registry[qualifierName];
    var module = constructModuleFromTemplate(template);

    attachmentPoint.appendChild(module.element);
  }

  function constructModuleFromTemplate(template, parent){
    var children = template.children;
    var root = template.node;
    var ModuleConstructor =  moduleRegistry.registry[template.qualifierName];
    var module = null;

    if(templateRegistry.registry[template.qualifierName]) {
      root = document.createElement('div');
      root.classList = template.qualifierName
        .split('.')
        .reverse()
        .reduce((acc, _, index, children)=> {
          var classes = [];

          var list = [];
          for (var i = 0; i <= index; i++) {
            list.push(children[i]);
            classes.push(list.map((j)=>j));
          }

          acc.push(list.join('__'));
          return acc
        }, [])
        .join(' ');
    }

    if(ModuleConstructor){
      module = new ModuleConstructor();
      module.inject(root, parent);
    }

    children
      .map((child)=>{return {qualifierName: child.qualifierName, attributes: child.attributes, node:child.node.cloneNode(true), children: child.children};})
      .map((child)=>{
        var template = templateRegistry.registry[child.qualifierName];
        var passedOnNode = child;

        if(template) {
          template =  {qualifierName: template.qualifierName, attributes: child.attributes, node:template.node.cloneNode(true), children: template.children}
          if (child.children.length > 0) {
            var contentAttachment = template.children.filter((it)=>it.node.getAttribute('data-content') !== null)[0];

            if (!contentAttachment) {
              throw "No place to attach content";
            }

            contentAttachment.children = contentAttachment.children.concat(child.children);

            passedOnNode = template;
          } else {
            passedOnNode = template;
          }
        }

        return passedOnNode; })
      .map((child)=>constructModuleFromTemplate(child, module))
      .map((module)=>{
        return root.appendChild(module.element);
      });

    module && module.mounted();
    return module || {element:root};
  }

</script>

